<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Dictation Practice</title>
</head>

<script>
// ========================================
// TEACHER CONFIGURATION SECTION
// ========================================

// ë°›ì•„ì“°ê¸° ë¬¸ì¥ë“¤ì„ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”
const sentences = [
    "I'd like to play soccer with my friends.",
    "She goes to school by bus every day.",
    "We had pizza for lunch yesterday.",
    "My brother is reading a book now.",
    "They will visit the park tomorrow.",
    "I can swim very well.",
    "He wants to be a teacher.",
    "We are studying English at school."
];

// ì±„ì  ì˜µì…˜
const scoringOptions = {
    checkPunctuation: true,     // true: êµ¬ë‘ì  í¬í•¨í•˜ì—¬ ì±„ì , false: êµ¬ë‘ì  ë¬´ì‹œ
    checkCapitalization: true   // true: ëŒ€ì†Œë¬¸ì êµ¬ë¶„í•˜ì—¬ ì±„ì , false: ëŒ€ì†Œë¬¸ì ë¬´ì‹œ
};

// TTS ìŒì„± ì˜µì…˜ (ì„ íƒì‚¬í•­)
const voiceOptions = {
    rate: 1.5,      // ë§í•˜ê¸° ì†ë„ (0.1 ~ 10, ê¸°ë³¸ê°’: 1)
    pitch: 3,       // ìŒë†’ì´ (0 ~ 2, ê¸°ë³¸ê°’: 1)
    volume: 1       // ìŒëŸ‰ (0 ~ 1, ê¸°ë³¸ê°’: 1)
};

// ========================================
// END OF CONFIGURATION SECTION
// ========================================
</script>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }

    .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        padding: 40px;
        max-width: 800px;
        width: 100%;
    }

    h1 {
        text-align: center;
        color: #667eea;
        margin-bottom: 30px;
        font-size: 2.5em;
    }

    .progress {
        text-align: center;
        margin-bottom: 20px;
        font-size: 1.1em;
        color: #666;
        font-weight: 600;
    }

    .instruction {
        background: #e3f2fd;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
        text-align: center;
    }

    .instruction p {
        font-size: 1.1em;
        color: #1976d2;
        margin-bottom: 10px;
    }

    .audio-controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    button {
        padding: 15px 30px;
        font-size: 1.1em;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
    }

    #playBtn {
        background: #667eea;
        color: white;
    }

    #playBtn:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    #playBtn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
    }

    .play-icon::before {
        content: 'ğŸ”Š ';
    }

    .voice-selector {
        margin-bottom: 20px;
        text-align: center;
    }

    .voice-selector label {
        display: inline-block;
        font-size: 1em;
        color: #666;
        margin-right: 10px;
        font-weight: 600;
    }

    #voiceSelect {
        padding: 10px 15px;
        font-size: 1em;
        border: 2px solid #ddd;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: border-color 0.3s;
        min-width: 250px;
    }

    #voiceSelect:focus {
        outline: none;
        border-color: #667eea;
    }

    .input-section {
        margin-bottom: 30px;
    }

    .input-section label {
        display: block;
        font-size: 1.1em;
        color: #333;
        margin-bottom: 10px;
        font-weight: 600;
    }

    #answerInput {
        width: 100%;
        padding: 15px;
        font-size: 1.1em;
        border: 2px solid #ddd;
        border-radius: 10px;
        transition: border-color 0.3s;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    #answerInput:focus {
        outline: none;
        border-color: #667eea;
    }

    .submit-controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    #submitBtn {
        background: #48bb78;
        color: white;
    }

    #submitBtn:hover:not(:disabled) {
        background: #38a169;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
    }

    #submitBtn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    #nextBtn {
        background: #4299e1;
        color: white;
    }

    #nextBtn:hover {
        background: #3182ce;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(66, 153, 225, 0.4);
    }

    #showAnswerBtn {
        background: #ed8936;
        color: white;
    }

    #showAnswerBtn:hover:not(:disabled) {
        background: #dd6b20;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(237, 137, 54, 0.4);
    }

    #showAnswerBtn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .score-display {
        background: #fff3cd;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
    }

    .score-display h3 {
        color: #856404;
        margin-bottom: 10px;
    }

    .score-value {
        font-size: 2.5em;
        font-weight: bold;
        color: #667eea;
    }

    .comparison {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .comparison h4 {
        margin-bottom: 15px;
        color: #333;
    }

    .text-compare {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .compare-row {
        display: flex;
        gap: 10px;
        align-items: flex-start;
    }

    .compare-label {
        font-weight: bold;
        min-width: 100px;
        color: #666;
    }

    .compare-text {
        flex: 1;
        padding: 15px;
        background: white;
        border-radius: 5px;
        font-family: 'Courier New', monospace;
        font-size: 1.1em;
        line-height: 1.6;
    }

    .correct-answer {
        background: #c6f6d5;
    }

    .user-answer {
        background: #fed7d7;
    }

    .status {
        text-align: center;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1.1em;
    }

    .status.speaking {
        background: #c6f6d5;
        color: #22543d;
    }

    .status.error {
        background: #fed7d7;
        color: #742a2a;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }

    .speaking-animation {
        animation: pulse 1s ease-in-out infinite;
    }

    .hidden {
        display: none !important;
    }
</style>

<body>
    <div class="container">
        <h1>ğŸ“ English Dictation Practice</h1>

        <div class="progress">
            <span id="progressText"></span>
        </div>

        <div class="instruction">
            <p>ğŸ§ Listen carefully and type what you hear</p>
            <p style="font-size: 0.95em; color: #666;">Click the play button to hear the sentence</p>
        </div>

        <div class="voice-selector">
            <label for="voiceSelect">Voice:</label>
            <select id="voiceSelect">
                <option value="">Loading voices...</option>
            </select>
        </div>

        <div class="audio-controls">
            <button id="playBtn" class="play-icon">Play Audio</button>
        </div>

        <div id="statusDiv" class="status hidden"></div>

        <div class="input-section">
            <label for="answerInput">Your Answer:</label>
            <textarea id="answerInput" rows="3" placeholder="Type what you hear here..."
                      spellcheck="false"
                      autocomplete="off"
                      autocorrect="off"
                      autocapitalize="off"></textarea>
        </div>

        <div class="submit-controls">
            <button id="submitBtn">Submit Answer</button>
            <button id="showAnswerBtn">Show Answer</button>
            <button id="nextBtn" class="hidden">Next Question</button>
        </div>

        <div id="scoreDiv" class="score-display hidden">
            <h3>Your Score</h3>
            <div class="score-value" id="scoreValue">0%</div>
        </div>

        <div id="comparisonDiv" class="comparison hidden">
            <h4>Comparison:</h4>
            <div class="text-compare">
                <div class="compare-row">
                    <span class="compare-label">Correct Answer:</span>
                    <div class="compare-text correct-answer" id="correctText"></div>
                </div>
                <div class="compare-row">
                    <span class="compare-label">Your Answer:</span>
                    <div class="compare-text user-answer" id="yourText"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSentenceIndex = 0;
        let synth = window.speechSynthesis;
        let currentUtterance = null;
        let hasSubmitted = false;
        let availableVoices = [];

        // ìŒì„± ëª©ë¡ ë¡œë“œ ë° ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
        function loadVoices() {
            availableVoices = synth.getVoices();
            const englishVoices = availableVoices.filter(voice => voice.lang.startsWith('en'));

            const voiceSelect = document.getElementById('voiceSelect');
            voiceSelect.innerHTML = '';

            if (englishVoices.length === 0) {
                voiceSelect.innerHTML = '<option value="">No English voices available</option>';
                return;
            }

            englishVoices.forEach((voice, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${voice.name} (${voice.lang})`;
                option.setAttribute('data-voice-name', voice.name);
                voiceSelect.appendChild(option);
            });

            // localStorageì—ì„œ ì €ì¥ëœ ìŒì„± ë³µì›
            const savedVoiceName = localStorage.getItem('selectedVoice');
            if (savedVoiceName) {
                const savedOption = Array.from(voiceSelect.options).find(
                    opt => opt.getAttribute('data-voice-name') === savedVoiceName
                );
                if (savedOption) {
                    voiceSelect.value = savedOption.value;
                }
            }
        }

        // ì„ íƒëœ ìŒì„± ê°€ì ¸ì˜¤ê¸°
        function getSelectedVoice() {
            const voiceSelect = document.getElementById('voiceSelect');
            const selectedIndex = parseInt(voiceSelect.value);
            const englishVoices = availableVoices.filter(voice => voice.lang.startsWith('en'));

            if (isNaN(selectedIndex) || selectedIndex >= englishVoices.length) {
                return englishVoices[0] || availableVoices[0];
            }

            return englishVoices[selectedIndex];
        }

        // ìŒì„± í•©ì„± ì¬ìƒ
        function playCurrentSentence() {
            if (synth.speaking) {
                synth.cancel();
            }

            const text = sentences[currentSentenceIndex];
            currentUtterance = new SpeechSynthesisUtterance(text);

            // ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒí•œ ìŒì„± ì‚¬ìš©
            const selectedVoice = getSelectedVoice();
            if (selectedVoice) {
                currentUtterance.voice = selectedVoice;
            }

            currentUtterance.lang = 'en-US';
            currentUtterance.rate = voiceOptions.rate;
            currentUtterance.pitch = voiceOptions.pitch;
            currentUtterance.volume = voiceOptions.volume;

            currentUtterance.onstart = function() {
                showStatus('ğŸ”Š Playing audio...', 'speaking');
                document.getElementById('playBtn').disabled = true;
                document.getElementById('playBtn').classList.add('speaking-animation');
            };

            currentUtterance.onend = function() {
                hideStatus();
                document.getElementById('playBtn').disabled = false;
                document.getElementById('playBtn').classList.remove('speaking-animation');
            };

            currentUtterance.onerror = function(event) {
                showStatus('Error playing audio: ' + event.error, 'error');
                document.getElementById('playBtn').disabled = false;
                document.getElementById('playBtn').classList.remove('speaking-animation');
            };

            synth.speak(currentUtterance);
        }

        // ë‹µì•ˆ ì œì¶œ ë° ì±„ì 
        function submitAnswer() {
            const userAnswer = document.getElementById('answerInput').value.trim();

            if (!userAnswer) {
                showStatus('Please type your answer first!', 'error');
                setTimeout(hideStatus, 2000);
                return;
            }

            const correctAnswer = sentences[currentSentenceIndex];
            const score = calculateScore(userAnswer, correctAnswer);

            // ì ìˆ˜ í‘œì‹œ
            document.getElementById('scoreValue').textContent = score + '%';
            document.getElementById('scoreDiv').classList.remove('hidden');

            // ë¹„êµ í‘œì‹œ
            document.getElementById('correctText').textContent = correctAnswer;
            document.getElementById('yourText').textContent = userAnswer;
            document.getElementById('comparisonDiv').classList.remove('hidden');

            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('showAnswerBtn').disabled = true;
            document.getElementById('answerInput').disabled = true;
            hasSubmitted = true;

            // ë‹¤ìŒ ë²„íŠ¼ í‘œì‹œ
            if (currentSentenceIndex < sentences.length - 1) {
                document.getElementById('nextBtn').classList.remove('hidden');
            }
        }

        // ì±„ì  ê³„ì‚°
        function calculateScore(userAnswer, correctAnswer) {
            let processedCorrect = correctAnswer;
            let processedUser = userAnswer;

            // ì˜µì…˜ì— ë”°ë¼ í…ìŠ¤íŠ¸ ì „ì²˜ë¦¬
            if (!scoringOptions.checkPunctuation) {
                processedCorrect = processedCorrect.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?"']/g, "");
                processedUser = processedUser.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?"']/g, "");
            }

            if (!scoringOptions.checkCapitalization) {
                processedCorrect = processedCorrect.toLowerCase();
                processedUser = processedUser.toLowerCase();
            }

            // ì—¬ëŸ¬ ê³µë°±ì„ í•˜ë‚˜ë¡œ í†µì¼í•˜ê³  ì•ë’¤ ê³µë°± ì œê±°
            processedCorrect = processedCorrect.replace(/\s+/g, ' ').trim();
            processedUser = processedUser.replace(/\s+/g, ' ').trim();

            // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš°
            if (processedCorrect === processedUser) {
                return 100;
            }

            // Levenshtein ê±°ë¦¬ ê¸°ë°˜ ìœ ì‚¬ë„ ê³„ì‚°
            const distance = levenshteinDistance(processedCorrect, processedUser);
            const maxLength = Math.max(processedCorrect.length, processedUser.length);
            const similarity = maxLength === 0 ? 100 : ((maxLength - distance) / maxLength) * 100;
            const score = Math.max(0, Math.round(similarity));

            return score;
        }

        // Levenshtein ê±°ë¦¬ ê³„ì‚°
        function levenshteinDistance(str1, str2) {
            const matrix = [];

            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            return matrix[str2.length][str1.length];
        }

        // ì •ë‹µ ë³´ê¸°
        function showAnswer() {
            const correctAnswer = sentences[currentSentenceIndex];
            document.getElementById('answerInput').value = correctAnswer;
            document.getElementById('answerInput').disabled = true;
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('showAnswerBtn').disabled = true;

            // ì •ë‹µ í‘œì‹œ
            document.getElementById('correctText').textContent = correctAnswer;
            document.getElementById('yourText').textContent = '(You viewed the answer)';
            document.getElementById('comparisonDiv').classList.remove('hidden');

            // ì ìˆ˜ 0ì  ì²˜ë¦¬
            document.getElementById('scoreValue').textContent = '0%';
            document.getElementById('scoreDiv').classList.remove('hidden');

            // ë‹¤ìŒ ë²„íŠ¼ í‘œì‹œ
            if (currentSentenceIndex < sentences.length - 1) {
                document.getElementById('nextBtn').classList.remove('hidden');
            }
        }

        // ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™
        function nextQuestion() {
            currentSentenceIndex++;

            if (currentSentenceIndex >= sentences.length) {
                showStatus('ğŸ‰ All questions completed! Refresh the page to start over.', 'speaking');
                document.getElementById('playBtn').disabled = true;
                document.getElementById('nextBtn').disabled = true;
                return;
            }

            // UI ì´ˆê¸°í™”
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').disabled = false;
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('showAnswerBtn').disabled = false;
            document.getElementById('scoreDiv').classList.add('hidden');
            document.getElementById('comparisonDiv').classList.add('hidden');
            document.getElementById('nextBtn').classList.add('hidden');
            hasSubmitted = false;

            // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
            document.getElementById('progressText').textContent =
                `Question ${currentSentenceIndex + 1} of ${sentences.length}`;
        }

        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showStatus(message, className) {
            const statusDiv = document.getElementById('statusDiv');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + className;
            statusDiv.classList.remove('hidden');
        }

        // ìƒíƒœ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
        function hideStatus() {
            document.getElementById('statusDiv').classList.add('hidden');
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('playBtn').addEventListener('click', playCurrentSentence);
        document.getElementById('submitBtn').addEventListener('click', submitAnswer);
        document.getElementById('showAnswerBtn').addEventListener('click', showAnswer);
        document.getElementById('nextBtn').addEventListener('click', nextQuestion);

        // ìŒì„± ì„ íƒ ë³€ê²½ ì‹œ localStorageì— ì €ì¥
        document.getElementById('voiceSelect').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const voiceName = selectedOption.getAttribute('data-voice-name');
            if (voiceName) {
                localStorage.setItem('selectedVoice', voiceName);
            }
        });

        // Enter í‚¤ë¡œ ì œì¶œ
        document.getElementById('answerInput').addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && event.ctrlKey && !hasSubmitted) {
                event.preventDefault();
                submitAnswer();
            }
        });

        // ìŒì„± ë¡œë”© ëŒ€ê¸°
        window.speechSynthesis.onvoiceschanged = function() {
            loadVoices();
        };

        // ì´ˆê¸°í™”
        window.onload = function() {
            // ìŒì„± ëª©ë¡ ë¡œë“œ
            loadVoices();

            // ì´ˆê¸° ì§„í–‰ ìƒí™© í‘œì‹œ
            document.getElementById('progressText').textContent =
                `Question ${currentSentenceIndex + 1} of ${sentences.length}`;

            // í˜ì´ì§€ ë‚˜ê°ˆ ë•Œ ìŒì„± ì¤‘ì§€
            window.addEventListener('beforeunload', function() {
                if (synth.speaking) {
                    synth.cancel();
                }
            });
        };
    </script>
</body>
</html>